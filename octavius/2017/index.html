<!DOCTYPE html>
<html lang="ru">
<head>
	<title>Почта MailRu</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=792, user-scalable=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<link rel="stylesheet" href="../../shwr/styles/screen.css">

	<style>
		.slide .next.shade {
			opacity: 1;
			position: absolute;
			left: 0;
			right: 0;
			bottom: 0;
			background: #fff;
			transition: all .5s;
		}
		.slide .next.active.shade {
			opacity: 0;
		}
	</style>
</head>
<body class="list">

	<header class="caption">
		<h1>Почта MailRu</h1>
		<p></p>
	</header>

	<section class="slide shout"><div>
		<h2>Почта Mail.ru</h2>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/BootScheme.png" height="100%" style="margin-left: 100px; margin-top: 40px;"/>
	</div></section>

	<section class="slide shout"><div>
		<h2>Данные и API</h2>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/apidoc-index.png" width="100%"/>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/apidoc-variants.png" width="100%"/>
	</div></section>

	<section class="slide"><div>
		<h2>Данные и API</h2>
		<ul>
			<li>Постановка</li>
			<li>Проектирование</li>
			<li>Соглосование</li>
			<li>Отправка Pull Request</li>
			<li>Реализация*</li>
			<li>Покрытие автотестами*</li>
		</ul>
		<p style="text-align: right;">* — backend</p>
	</div></section>

	<section class="slide shout"><div>
		<h2>JSSDK</h2>
	</div></section>

	<section class="slide"><div>
		<h2>JSSDK</h2>
		<ul>
			<li>Прозрачность для работчика</li>
			<li>Расширяемость (свои обработчики событий, перехват обработки ошибок и т.п.)</li>
			<li>Инкапсуляция всей бизнес логики и самодостаточность</li>
			<li>Персистентность данных</li>
			<li>Независимость от проекта</li>
			<li>100% покрытие тестами</li>
			<li>Документация</li>
		</ul>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/jssdk-core.png" height="90%" style="margin-left: 90px; margin-top: 30px;"/>
	</div></section>

	<section class="slide shout"><div>
		<h2>Раньше</h2>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/api-flow.png" height="90%" style="margin-left: 90px; margin-top: 60px;"/>

		<div class="next shade" style="top: 170px;"></div>
		<div class="next shade" style="top: 210px;"></div>
		<div class="next shade" style="top: 250px;"></div>
		<div class="next shade" style="top: 290px;"></div>
		<div class="next shade" style="top: 330px;"></div>
		<div class="next shade" style="top: 360px;"></div>

		<div class="next shade" style="top: 400px;">
			<div style="position: absolute; background: #fff; top: -30px; height: 40px; width: 550px; right: 0;"></div>
		</div>
	</div></section>

	<section class="slide"><div>
		<h2>В итоге раньше надо было</h2>
		<ul>
			<li>Разбор всех статусов (на данный момент их 25)</li>
			<li>Принятие решения в зависмости от статуса и его ограничений</li>
			<li>Корректно реагировать на ошибки при работе с api</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>JSSDK: Thread</h2>
		<pre class="js-code">
			// Получение списка тредов
			Thread.find({folder: 8}).then(threads => {
				// ...
			});
		</pre>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/jssdk-api-flow.png" height="90%" style="margin-left: 60px; margin-top: 30px;"/>
	</div></section>

	<section class="slide"><div>
		<h2>Пример перехвата</h2>
		<pre class="js-code compact">
			RPC.intercept({
				#! status: "invalid",
				#!+ process(req) {
					#!+ if (req.get("body.folder.error") === "not_open") {
						 // вернёт Promise
						return openSecureFolderLayer({
							folder: req.get("body.folder.value")
						});
					#!- }
				#!- }
			});
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>Стало</h2>
		<ul>
			<li>Вся логика скрыта в JSSDK</li>
			<li>Наружу выведены события</li>
			<li>Разработчик оперирует моделями</li>
		</ul>
	</div></section>

	<section class="slide shout"><div>
		<h2>JSSDK: Models</h2>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/base-models.png" height="90%" style="margin-left: 80px; margin-top: 30px;"/>
	</div></section>

	<section class="slide"><div>
		<h2>Методы получения модели</h2>
		<ul>
			<li><b>find</b>(query) — получить список моделей</li>
			<li><b>findOne</b>(id) / findOne(query) — модель по id или некому условию</li>
			<li><b>get</b>(id) — получить модель из RuntimeCache (если есть)</li>
			<li><b>getSafe</b>(id) — получить модель независимо от её наличия</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Базовый интрейфейс модели</h2>
		<ul>
			<li><b>isNew</b>() - явялется ли модель «новой»?</li>
			<li><b>isDataFully</b>([query]) - проверить полноту данных</li>
			<li><b>is</b>(name) — проверить значение на истиность</li>
			<li><b>get</b>(name) — получить значение</li>
			<li><b>set</b>(name, value) - изменить</li>
			<li><b>previous</b>(name) - предыдущее значение</li>
			<li><b>toJSON</b>() - получить чистые данные</li>
		</ul>
		<p style="text-align: right; margin-top: -30px;">
			* <b>name</b> — поддерживаем нотацию
		</p>
	</div></section>

	<section class="slide"><div>
		<h2>JSSDK: Models</h2>
		<ul>
			<li><b>Персистентность</b></li>
			<li>Работа с неполными данными — об этом чуть позже</li>
			<li><b>Поддержка вложенных моделей</b></li>
			<li><b>Дедупликация запросов</b></li>
			<li>Кеширование</li>
			<li>Значения по умолчанию</li>
			<li>Валидация атрибутов</li>
			<li>Логирование</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Персистентность</h2>
		<pre class="js-code compact-s">
			// Где-то получаем тред
			Thread.findOne(123).then(thread => {
			#!+	thread.get("messages.0").on("change:flags", () => {
					// Реагируем на изменение флагов
			#!-	});
			});

			#!+ // Где-то письмо (которое входит в тред)
			Message.findOne(345).then(message => {
				#!+ // Инвертируем флаг
				#!- message.set("flags.unread", !message.is("flags.unread"));
			#!- });
		</pre>
		<div class="next">
			<img src="media/arrow-rdu.png" style="
				position: absolute;
				right: 150px;
				top: 260px;
				transform: rotateZ(-10deg);
			"/>
		</div>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -50px">Поддержка вложенных моделей</h2>
		<pre class="js-code">
			const Thread = Message.extend({
				#! className: "mail.Thread", // для логирования
				#! findUrl: "threads", // Получение списка тредов
				#! findOneUrl: "threads/thread", // Запрос за тредом
				#!+ defaults: { // Свойства по умолчанию
					...Message.fn.defaults,
					length: 0,
					**messages: new Message.List.Sorted**,
				#!- }
			});
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -50px">Валидация атрибутов</h2>
		<pre class="js-code compact-s">
			// Письмо
			const Message = RPCModel.extends({
				defaults: {
					// ...
					attachments: new Attachment.List.Local(),
				},
				// Валидация атрибутов при изменении
				valueValidator(newValue, attr, newAttrs, model) {
					#! return <mark>check(attr, newValue)</mark> ? newValue : model.get(attr);
				}
			});

			// Отсортированный список моделей
			Message.List.Sorted = Message.List.extend({
				comparator: {date: true} // desc
			});
		</pre>
	</div></section>

	<section class="slide shout"><div>
		<h2 style="font-size: 500%">Неполные данные</h2>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -50px">Неполные данные</h2>
		<pre class="js-code compact">
			const Thread = Message.extend({
				<s>findOneUrl: "threads/thread"</s>
				#!+ findOneUrl(query) { return query.withoutQuote
						? "threads/thread/short"
						: "threads/thread"
				#!- },
				// ...
				#!+ isDataFully(query) {
					#! return this.is("messages.lentgh") || query.withoutQuote;
				#!- }
			});
		</pre>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/jssdk-thread-flow.png" height="95%" style="margin-left: 30px; margin-top: 30px;"/>
		<div class="next shade" style="top: 400px;"></div>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -50px">Группировка</h2>
		<pre class="js-code">
			Promise.all([
				Folder.findOne(123), // Первый запрос
				Thread.find({folder: 123}) // Второй :[
			]).then(([folder, threads]) => {
				// ..
			});
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -50px">Группировка</h2>
		<pre class="js-code">
			<mark>RPC.batch(() =></mark> Promise.all([
				Folder.findOne(123),
				Thread.find({folder: 123})
			])).then(([folder, threads]) => {
				// ..
			});
		</pre>
	</div></section>

	<section class="slide shout"><div>
		<h2>Логирование</h2>
	</div></section>

	<section class="slide cover"><div>
		<pre class="js-code" style="margin: -40px 0 0 -100px; box-shadow: none; border-bottom: 2px solid #ccc;">
			Folder.find().then(folders => { ... });
		</pre>
		<img src="media/jssdk-model-log.png" width="100%" style="margin-top: 160px;"/>
	</div></section>

	<section class="slide shout"><div>
		<h2>Ошибки</h2>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -50px;">Ошибки</h2>
		<pre class="js-code compact-xs">
			request.on("error", (evt, req) => {
				saveToLog(req);
			});
		</pre>

		<div style="display: flex; margin: -30px -70px 0 -20px; font-size: 87%;">
			<ul class="next" style="flex-basis: 45%;">
				<li><b>uuid</b>:`string` — id запроса</li>
				<li><b>url</b>:`string` — что запрашивали</li>
				<li><b>type</b>:`string` — GET, POST и т.п.</li>
				<li><b>data</b>:`Object` — Параметры запроса</li>
				<li><b>options</b>:`Object` — Опции запроса</li>
				<li><b>body</b>:`Object` — Ответ (JSON)</li>
				<li><b>error</b>:`*` — Ошибка</li>
				<li><b>responseText</b>:`*` — raw-ответ</li>
			</ul>
			<ul class="next">
				<li><b>startTime</b>:`number` — Время начала запроса</li>
				<li><b>endTime</b>:`number` — Время завершения</li>
				<li><b>duration</b>:`number` — Продолжительность запроса</li>
				<li><b>aborted</b>:`boolean` — Отменен</li>
				<li><b>batched</b>:`boolean` — В «пачке»
				<li><b>pending</b>:`boolean` — В ожидании ответа</li>
				<li><b>retries</b>:`number` — Количество попыток</li>
			</ul>
		</div>
	</div></section>

	<section class="slide shout"><div>
		<h2>«Действие»</h2>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -50px;">Пример MoveTo</h2>
		<pre class="js-code compact-s">
			MoveTo.execute({
				#! folderTo: 123, // id папки куда переносим
				#! models: [...] // Массив Писем или Тредов (модели)
			}).then(action => {
				#!+ // Ссылка на модель Папки куда переместили
				#!- const folderTo = action.folderTo;

				#!+ // Список реально перемещенных моделей
				#!- const affectedModels = action.models;

				#!+ // Показывает нотификацию для отмены действия
				#!- showUndoNotify().onUndo(() => action.undo());
			});
		</pre>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/jssdk-action-flow.png" width="90%" style="margin-top: 60px; margin-left: 55px;"/>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -50px;">«Действие» / Lifecycle</h2>
		<pre class="js-code compact">
			const MyAction = Action.extend(/** @lends MyAction# */{
				#!+ // Подготовка данных
				prepare(params, options) {
					return {computed: params.foo + params.bar};
				#!- },
				#!+ // Выполняемая операция
				#!- operation({computed}, params, options) { /* … */ },
				#!+ // Обратная операция
				#!- undoOperation(data, params, options) { /* … */  },
				#!+ // Откатываем изменения в случае ошибки при выполнении
				#!- rollbackOperation() { }
			});
		</pre>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/jssdk-coverage.png" width="100%"/>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/jssdk-docs.png" width="100%"/>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/jssdk-docs-2.png" width="100%"/>
	</div></section>

	<section class="slide cover"><div>
		<h2 style="font-size: 700%; margin-top: 120px;">Приложение</h2>
		<img src="media/octavius-and-inspector.png" width="100%"/>
	</div></section>

	<section class="slide cover"><div>
		<h2 style="font-size: 700%; margin-top: 120px;">Установка</h2>
		<img src="media/octavius-readme-1.png" width="100%" style="margin-top: 40px;"/>
	</div></section>

	<section class="slide cover"><div>
		<h2 style="font-size: 600%; margin-top: 80px;">Общие сведения</h2>
		<img src="media/octavius-readme-2.png" width="100%"/>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -50px;">Точка вход</h2>
		<pre class="js-code">
			require(["app/app", "logger"], function (app, logger) {
				#!+ // Скрыть лоудер загрузки приложения
				#!- app.ready(hideLoading);
				#!+ // Перехват ссылок и запуск приложения
				app.listenFrom(document, {
					autoStart: true,
					logger: logger
				#!- });
			});
		</pre>
	</div></section>

	<section class="slide shout"><div>
		<h2>Что такое app?</h2>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -50px">Что такое app?</h2>
		<pre class="js-code">
			const app = Pilot.create({
				#! model: { /* модели доступные всем маршрутам */
				#!+ "#letters": {
					url: "/:folder", // "/inbox/", "/trash/" или "/123/"
					#!+ model: { // модели конкретного маршрута
						threads: ({params: {folder}}) => Thread.find({folder})
					#!- }
				#!- },
			});
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -50px">Навигация по id</h2>
		<pre class="js-code">
			// Перейти на нужный маршрут
			app.go("#letters");
			app.go("#letters", {folder: "inbox"});

			// Сформировать url
			app.getUrl("#letters", {folder: 123});
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -50px">Продвинутая настройка маршрута</h2>
		<pre class="js-code compact-s">
			"#letters": {
				url: {
					#! pattern: "/:folder",
					#!+ params: {
						folder: {
							#! default: Folder.INBOX,
							#! decode: (value) => TYPE2ID[value] || parseInt(value, 10),
							#! encode: (value) => (value in ID2TYPE) ? ID2TYPE[value] : value,
						}
					#!- }
				},
				model: { /*...*/ },
				// ...
			}
		</pre>
	</div></section>

	<section class="slide shout"><div>
		<h2>Глобальная модель</h2>
	</div></section>

	<section class="slide"><div>
		<pre class="js-code compact-xs" style="margin-top: -80px; margin-left: -40px;">
			export default {
				// Статус ящика
				status: ({params: {folder}}) => loadStatus(folder),
				#!+ // Список папок
				#!- folders: (req, waitFor) => **waitFor("status")**.then(status => status.folders),
				#!+ // Текущая папка
				folder(req, waitFor) {
					if (req.is("#read-letter")) {
						#!+ return Promise
							  .all([**waitFor("folders"), waitFor("letter")**])
						#!-	   .then(([folders, letter]) => folders.get(letter.get("folder")));
					} else {
						#! return waitFor("folders").then(folders => folders.get(req.params.folder));
					}
				#!- },
				#!+ // Список писем
				#!- letters: (req, waitFor) => waitFor("status").then(status => status.letters),
				#!+ // Письмо
				letter: {
					match: ["#read-letter", "#search-letter"],
					fetch: ({params:{letter}}, waitFor) =>
											waitFor("status").then(() => Thread.findOne(letter))
				},
				#!-
			}
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>Pilot.Request</h2>
		<div style="display: flex; ">
			<ul style="width: 60%">
				<li><b>query</b> — GET-параметры</li>
				<li><b>params</b> — параметры маршрута</li>
				<li><b>route</b> — текущий маршрут</li>
				<li><b>router</b> — ссылка на роутер</li>
			</ul>
			<ul style="width: 40%; font-size: 80%">
				<li>href</li>
				<li>protocol</li>
				<li>host</li>
				<li>hostname</li>
				<li>port</li>
				<li>pathname</li>
				<li>search</li>
				<li>hash</li>
				<li>referrer</li>
			</ul>
		</div>
	</div></section>

	<section class="slide"><div>
		<h2>Итого, данные деляться на два типа</h2>
		<ul>
			<li>Глобальные — доступные всем маршрутам</li>
			<li>Локальные — для конкретного маршрута</li>
		</ul>
		<p>
			Кроме этого, ещё есть Медиаторы, но о них позже.
		</p>
	</div></section>

	<section class="slide shout"><div>
		<h2>UIApplication</h2>
	</div></section>

	<section class="slide shout"><div>
		<h2>Всё есть блоки</h2>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/app-struct-shot-idx.png" width="100%"/>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/app-struct-shot-dataset.png" width="95%" style="margin-left: 10px; margin-top: 50px;"/>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/app-struct-shot-panel-with-selected.png" width="100%"/>
	</div></section>

	<section class="slide shout"><div>
		<h2 style="font-size: 250%">— У нас нет «глупых/умных» блоков,<br/>они все «глупые»</h2>
	</div></section>

	<section class="slide shout"><div>
		<h2 style="font-size: 250%">— У нас нет «глупых/умных» блоков,<br/>они все «глупые»</h2>
	</div></section>

	<section class="slide"><div>
		<h2>Структура блока</h2>
		<code>/Button/</code>
		<ul style="margin-left: 70px;">
			<li>Button.<b>js</b> — Контроллер поведения</li>
			<li>Button.<b>html</b> — Шаблон</li>
			<li>Button.<b>scss</b> — Стили</li>
			<li>Button.<b>spec.js</b> — Спецификация</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -30px">Button/Button.js</h2>
		<pre class="js-code compact-xs">
			import feast from "feast";
			import template from "feast-tpl!./button.html";

			// Используемые блоки
			import UIIco from "ui-block/ico/ico";

			/**
			 * @class UIButton
			 * @extends feast.Block
			 */
			export default feast.Block.extend(/** @lends UIButton# */{
				name: "button",
				template,
				blocks: {
					"ico": UIIco
				}
			});
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -80px">Button/Button.html</h2>
		<pre class="js-code compact-s">
			&lt;div title="{attrs.title || attrs.text}">
				#!+ &lt;bem:mod name="pressed" test="attrs.pressed && !attrs.disabled" />
				&lt;bem:mod name="borderless" test="attrs.borderless" />
				&lt;bem:mod name="primary" test="attrs.type == 'submit' || attrs.primary" />
				&lt;bem:mod name="size" value="{attrs.size}" test="attrs.size" />
				#!- &lt;bem:mod name="disabled" test="attrs.disabled" />
				#!+ &lt;fn:if test="attrs.ico">
					&lt;span **bem:elem="ico"**>
						&lt;bem:mod name="size" value="{attrs.size}" test="attrs.size" />
						&lt;bem:mod name="{'theme-'+attrs.theme}" test="attrs.theme" />
			
						&lt;**b:ico** name="{attrs.ico}" size="{attrs.size}"/>
					&lt;/span>
				#!- &lt;/fn:if>
				#!+ &lt;fn:if test="!attrs.short && attrs.text">
					&lt;span bem:elem="txt">{attrs.text}&lt;/span>
				#!- &lt;/fn:if>
			&lt;/div>
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -80px">Button/Button.scss</h2>
		<pre class="js-code compact-s">
			.button {
				// бла-бла-бла

				// Состояние: «нажата»
				&:active, &_pressed {
					// ...
				}
				// Основная кнопка
				&_primary {
					// ...
				}
				// Наличие иконки у кнопки
				&_has-ico {
					// ...
				}
				// и так далее
			}
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -80px">Button/Button.spec.js</h2>
		<pre class="js-code compact-s">
			export default {
				keywords: "btn кнопка",
				cases: {
					"base": {
						attrs: [{text: "Написать"}]
					},
					"primary": {
						attrs: [
							{type: "submit", text: "Написать"},
							{ico: "compose", type: "submit", text: "Написать"},
							{ico: "compose", short: true, type: "submit", text: "Написать"},
							{pressed: true, type: "submit", text: "Написать"}
						]
					},
				}
			};
		</pre>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/feast-button.png" width="100%"/>
	</div></section>

	<section class="slide shout"><div>
		<h2>Props Down<br/>Events Up</h2>
	</div></section>

	<section class="slide"><div>
		<h2>Props Down, Events Up</h2>
		<pre class="js-code">
			&lt;b:letter-status
				name="unread"
				#! state="{attrs.unread}"
				#! remit:<mark>click</mark>="<mark>invert:unread</mark>"
			/>
		</pre>
	</div></section>

	<section class="slide shout"><div>
		<h2>Блоки💖️JSSDK</h2>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -50px;">Блоки💖️JSSDK</h2>
		<div style="overflow: hidden;">
			<video controls loop autoplay style="margin-left: -50px; margin-right: -50px; width: calc(100% + 100px);">
				<source src="media/DatasetLetters.webm" type="video/webm"/>
				Зевс всемогущий, ну как так-то.
			</video>
		</div>
	</div></section>

	<section class="slide"><div>
		<h2>Блоки💖️JSSDK: <code>model</code> и <code>models</code></h2>
		<pre class="js-code">
			// Список тредов строится на основе Thread.List
			&lt;b:dataset-letters models="{attrs.model.threads}" />

			// Вывод треда
			&lt;b:thread model="{attrs.model.thread}" />
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>Блоки💖️JSSDK: on/off интерфейс</h2>
		<ul>
			<li>модель -> model.on("<b>change</b>", ...)</li>
			<li>список -> models.on("<b>add remove sort reset update</b>", ....)</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Итого</h2>
		<ul>
			<li>Все данные пробрасываются сверх &rarr; вниз</li>
			<li>Обратная связ через custom-events</li>
			<li>Обновление как полное, так и через подписку на модели/колекции</li>
		</ul>
	</div></section>

	<section class="slide shout"><div>
		<h2>Где логика?</h2>
	</div></section>

	<section class="slide shout"><div>
		<h2>Медиаторы</h2>
	</div></section>

	<section class="slide"><div>
		<h2>Пример</h2>
		<pre class="js-code">
			&lt;b:portal-menu
				#! use:mediator="letters-actions letters-selection"
			/>
			// ...
			&lt;b:thread
				model={attrs.model}
				#! use:mediator="letters-actions"
			/>
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>Медиаторы нужны для:</h2>
		<ul>
			<li>Связь с бизнес-локой / JSSDK</li>
			<li>Обработка событий</li>
			<li>Взаимодействия между блоками, которые ничего не знают о друг друге</li>
			<li>Хранить состояниея блоков</li>
			<li>и т.д.</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Медиаторы: Жизненный цикл</h2>
		<ul>
			<li>Регистрация компонента</li>
			<li>Подписка на события</li>
			<li>Обновление атрибутов</li>
			<li>Реакция на событие</li>
			<li>Какая-то внутренняя логика</li>
			<li>Обновление всех связанных компонентов</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<pre style="margin-top: -60px" class="js-code compact-xs">
			// Действия
			import MarkAsAction from "jssdk/mail/actions/MarkAs";
			import DeleteAction from "jssdk/mail/actions/Delete";
			#!+ // Другие медиаторы
			#!- import lettersSelection from "mediator/letters-selection";

			#!+ export default feast.Mediator.create("letters-actions", {
				components: {
					#!+ "dataset-letters": {  // имя для обращения внутри медиатора
						#! "class": UIDatasetLetters,
						#!+ // события, на которые подписывается медиатор
						#!- "events": ["invert:unread", "delete", ...]
					#!- },
					#!+ "nav-folders": {
						"class": UINavFodlers,
						"events": ["drop", "move"],
						**"handleEvent": "handleMoveTo"**
					#!- },
					// ...
				},
				handleEvent(evt) { /* ... */ },
				handleMoveTo(evt) { /* ... */ },
				// ...
			#!- });
		</pre>
	</div></section>

	<section class="slide"><div>
		<pre style="margin-top: -30px" class="js-code compact-xxs">
			export default feast.Mediator.create("layout-manager", {
				components: { /* ... */ },
				handleEvent(evt) {
					#!+ // Тип события
					#!- const type = evt.type;
					#!+ // Получаем список моделей от медиатора отвечающего за выделение писем
					#!- const selectedModels = lettersSelection.getModels();
					#!+
					if (type === "delete") {
						#!+ DeleteAction.execute({models: selectedModels})
							.then(this._done)
						#!-	.catch(this._fail);
					} else if (type === "move") {
						// ...
					}
					#!-
					#!+ swipeManager.reset(); // Закрываем свайпы
					lettersSelection.reset(); // Сбрасываем выделение
					#!-
					#! // По завершению `handleEvent`, всем связанные блоки с медиатором будут обновлены
				}
			});
		</pre>
	</div></section>

	<section class="slide cover"><div>
		<img src="media/app-struct-shot-idx-final.png" width="100%"/>
	</div></section>


	<section class="slide"><div>
		<h2>Сервисы</h2>
		<ul>
			<li><b>auth</b> — загрузка соответствующего типа авторизации (account, oauth) и запуск процесса логина</li>
			<li><b>compose</b> — форма написания письма (загрузка, инициализация, менеджмент окон)</li>
			<li><b>viewer</b> — приложение для просмотра документов, фотографий, архивов и любых других атачей</li>
			<li>и т.п.</li>
		</ul>
	</div></section>


	<section class="slide"><div>
		<h2>The End</h2>

		<a href="https://github.com/RubaXa">github.com/RubaXa</a><br/>
		<a href="https://twitter.com/ibnRubaXa">@ibnRubaXa</a>
	</div></section>

	<script src="../../shwr/shower.js"></script>
</body>
</html>
