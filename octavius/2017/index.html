<!DOCTYPE html>
<html lang="ru">
<head>
	<title>Почта MailRu</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=792, user-scalable=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<link rel="stylesheet" href="../../shwr/styles/screen.css">
</head>
<body class="list">

	<header class="caption">
		<h1>Почта MailRu</h1>
		<p></p>
	</header>


	<section class="slide shout"><div>
		<h2>Почта Mail.ru</h2>
	</div></section>

	<section class="slide cover"><div>
		<img src="img/BootScheme.png" height="100%" style="margin-left: 100px; margin-top: 40px;"/>
	</div></section>

	<section class="slide shout"><div>
		<h2>Данные и API</h2>
	</div></section>

	<section class="slide cover"><div>
		<img src="img/apidoc-index.png" width="100%"/>
	</div></section>

	<section class="slide cover"><div>
		<img src="img/apidoc-variants.png" width="100%"/>
	</div></section>

	<section class="slide"><div>
		<h2>Данные и API</h2>
		<ul>
			<li>Постановка</li>
			<li>Проектирование</li>
			<li>Соглосование</li>
			<li>Отправка Pull Request</li>
			<li>Реализация*</li>
			<li>Покрытие автотестами*</li>
		</ul>
		<p style="text-align: right;">* — backend</p>
	</div></section>

	<section class="slide shout"><div>
		<h2>JSSDK</h2>
	</div></section>

	<section class="slide"><div>
		<h2>JSSDK</h2>
		<ul>
			<li>Прозрачность для работчика</li>
			<li>Расширяемость (свои обработчики событий, перехват обработки ошибок и т.п.)</li>
			<li>Инкапсуляция всей бизнес логики и самодостаточность</li>
			<li>Персистентность данных</li>
			<li>Независимость от проекта</li>
			<li>100% покрытие тестами</li>
			<li>Документация</li>
		</ul>
	</div></section>

	<section class="slide cover"><div>
		<img src="img/jssdk-core.png" height="90%" style="margin-left: 90px; margin-top: 30px;"/>
	</div></section>

	<section class="slide shout"><div>
		<h2>Раньше</h2>
	</div></section>

	<section class="slide cover"><div>
		<img src="img/api-flow.png" height="90%" style="margin-left: 90px; margin-top: 60px;"/>
	</div></section>

	<section class="slide"><div>
		<h2>В итоге раньше надо было</h2>
		<ul>
			<li>Разбор всех статусов (на данный момент их 25)</li>
			<li>Принятие решения в зависмости от статуса и его ограничений</li>
			<li>Корректно реагировать на оишбки при работе с api</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>JSSDK: Thread</h2>
		<pre class="js-code">
			// Получение списка тредов
			Thread.find({folder: 8}).then(threads => {
				// ...
			});
		</pre>
	</div></section>

	<section class="slide cover"><div>
		<img src="img/jssdk-api-flow.png" height="90%" style="margin-left: 60px; margin-top: 30px;"/>
	</div></section>

	<section class="slide"><div>
		<h2>Пример перехвата</h2>
		<pre class="js-code compact">
			RPC.intercept({
				#! status: "invalid",
				#!+ process(req) {
					#!+ if (req.get("body.folder.error") === "not_open") {
						 // вернёт Promise
						return openSecureFolderLayer({
							folder: req.get("body.folder.value")
						});
					#!- }
				#!- }
			});
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>Стало</h2>
		<ul>
			<li>Вся логика скрыта в JSSDK</li>
			<li>На ружу выведены события</li>
			<li>Разработчик оперирует моделями</li>
		</ul>
	</div></section>

	<section class="slide shout"><div>
		<h2>JSSDK: Models</h2>
	</div></section>

	<section class="slide cover"><div>
		<img src="img/base-models.png" height="90%" style="margin-left: 80px; margin-top: 30px;"/>
	</div></section>

	<section class="slide"><div>
		<h2>Методы получения модели</h2>
		<ul>
			<li><b>find</b>(query) — получить список моделей</li>
			<li><b>findOne</b>(id) / findOne(query) — модель по id или некому условию</li>
			<li><b>get</b>(id) — получить модель из RuntimeCache (если есть)</li>
			<li><b>getSafe</b>(id) — получить модель независимо от её наличия</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Базовый интрейфейс модели</h2>
		<ul>
			<li><b>isNew</b>() - явялется ли модель «новой»?</li>
			<li><b>isDataFully</b>([query]) - проверить полноту данных</li>
			<li><b>is</b>(name) — проверить значение на истиность</li>
			<li><b>get</b>(name) — получить значение</li>
			<li><b>set</b>(name, value) - изменить</li>
			<li><b>previous</b>(name) - предыдущее значение</li>
			<li><b>toJSON</b>() - получить чистые данные</li>
		</ul>
		<p style="text-align: right; margin-top: -30px;">
			* <b>name</b> — поддерживаем нотацию
		</p>
	</div></section>

	<section class="slide"><div>
		<h2>JSSDK: Models</h2>
		<ul>
			<li><b>Персистентность</b></li>
			<li>Работа с неполными данными — об этом чуть позже</li>
			<li><b>Поддержка вложенных моделей</b></li>
			<li><b>Дедупликация запросов</b></li>
			<li>Кеширование</li>
			<li>Значения по умолчанию</li>
			<li>Валидация атрибутов</li>
			<li>Логирование</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Персистентность</h2>
		<pre class="js-code compact-s">
			// Где-то получаем тред
			Thread.findOne(123).then(thread => {
			#!+	thread.get("messages.0").on("change:flags", () => {
					// Реагируем на изменение флагов
			#!-	});
			});

			#!+ // Где-то письмо (которое входит в тред)
			Message.findOne(345).then(message => {
				#!+ // Инвертируем флаг
				#!- message.set("flags.unread", !message.is("flags.unread"));
			#!- });
		</pre>
		<div class="next">
			<img src="img/arrow-rdu.png" style="
				position: absolute;
				right: 150px;
				top: 260px;
				transform: rotateZ(-10deg);
			"/>
		</div>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -50px">Поддержка вложенных моделей</h2>
		<pre class="js-code">
			const Thread = Message.extend({
				#! className: "mail.Thread", // для логирования
				#! findUrl: "threads", // Получение списка тредов
				#! findOneUrl: "threads/thread", // Запрос за тредом
				#!+ defaults: { // Свойства по умолчанию
					...Message.fn.defaults,
					length: 0,
					**messages: new Message.List.Sorted**,
				#!- }
			});
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -50px">Валидация атрибутов</h2>
		<pre class="js-code compact-s">
			// Письмо
			const Message = RPCModel.extends({
				defaults: {
					// ...
					attachments: new Attachment.List.Local(),
				},
				// Валидация атрибутов при изменении
				valueValidator(newValue, attr, newAttrs, model) {
					#! return <mark>check(attr, newValue)</mark> ? newValue : model.get(attr);
				}
			});

			// Отсортированный список моделей
			Message.List.Sorted = Message.List.extend({
				comparator: {date: true} // desc
			});
		</pre>
	</div></section>

	<section class="slide shout"><div>
		<h2 style="font-size: 500%">Неполные данные</h2>
	</div></section>

	<section class="slide"><div>
		<h2 style="margin-top: -50px">Неполные данные</h2>
		<pre class="js-code compact">
			const Thread = Message.extend({
				<s>findOneUrl: "threads/thread"</s>
				#!+ findOneUrl(query) { return query.withoutQuote
						? "threads/thread/short"
						: "threads/thread"
				#!- },
				// ...
				#!+ isDataFully(query) {
					#! return this.is("body") || !query.withoutQuote;
				#!- }
			});
		</pre>
	</div></section>

	<section class="slide cover"><div>
		<img src="img/jssdk-thread-flow.png" height="95%" style="margin-left: 30px; margin-top: 30px;"/>
	</div></section>

	<section class="slide"><div>
		<h2>The End</h2>

		<a href="https://github.com/RubaXa">github.com/RubaXa</a><br/>
		<a href="https://twitter.com/ibnRubaXa">@ibnRubaXa</a>
	</div></section>

	<script src="../../shwr/shower.js"></script>
</body>
</html>
