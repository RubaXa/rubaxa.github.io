<!DOCTYPE html>
<html ng-app="hell">
<head>
	<meta charset="utf-8">
	<title>Ипотечный Ад</title>

	<style>
		input,
		.alert {
			text-align: center;
		}

		.input-group + .input-group {
			margin-top: 10px;
		}

		form .input-group-addon {
			width: 150px;
		}

		.panel {
			padding: 10px;
			width: 50%;
			min-width: 380px;
			margin: 0 auto;
		}

		.panel form {
			width: 100%;
		}
	</style>
</head>
<body>

<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.2/angular.min.js"></script>

<script src="//code.angularjs.org/1.3.0-rc.2/i18n/angular-locale_ru-ru.js"></script>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css"/>

<br/>

<div ng-controller="enjoy" class="container">
	<form class="panel panel-default">
		<div class="input-group">
			<span class="input-group-addon">Кредит</span>
			<input ng-model="credit" type="text" class="form-control">
			<span class="input-group-addon">x 1 000 000 Р</span>
		</div>

		<div class="input-group">
			<span class="input-group-addon">Процент</span>
			<input ng-model="percent" type="text" class="form-control">
			<span class="input-group-addon">%</span>
		</div>

		<div class="input-group">
			<span class="input-group-addon">На срок </span>
			<input ng-model="years" type="text" class="form-control">
			<span class="input-group-addon">лет</span>
		</div>

		<div class="input-group">
			<span class="input-group-addon">Буду отдавать по </span>
			<input ng-model="payment" type="text" class="form-control">
			<span class="input-group-addon">x 1000 Р</span>
		</div>

		<div class="input-group">
			<span class="input-group-addon">Снимаю за</span>
			<input ng-model="rent" type="text" class="form-control">
			<span class="input-group-addon">x 1000 Р</span>
		</div>

		<div class="input-group">
			<span class="input-group-addon">Доход</span>
			<input ng-model="income" type="text" class="form-control">
			<span class="input-group-addon">x 1000 Р</span>
		</div>

		<div class="input-group">
			<span class="input-group-addon">Расходов</span>
			<input ng-model="costs" type="text" class="form-control">
			<span class="input-group-addon">x 1000 Р</span>
		</div>
	</form>

	<div class="alert alert-info" role="alert" style="font-size: 130%;">
		Кредит будет погашен за {{remYears}} и {{remMonths}}.
	</div>

	<div class="alert alert-danger " role="alert" style="font-size: 200%;">
		<div>
			<strong>{{total | number}}</strong>
			или в
			<strong>{{(total / (credit * 1e6)).toFixed(2) | number}}</strong>
			раз больше
		</div>
		<hr/>
		<div>
			Выплатив {{totalPrecents | number}} по процентам
		</div>
	</div>

	<div class="alert alert-warning" role="alert" style="font-size: 130%;">
		За эти деньги вы могли бы снимать ещё
		<strong>{{(total / (rent * 1e3 * 12)) | number}}</strong>
		лет и вы бы накопили
		<strong>{{(period * (income - costs - rent) * 1e3) | number}}</strong>
	</div>

	<br/>

	<div ng-repeat="year in payYears">
		<h2>{{year.num}} год</h2>
		<table class="table">
			<tr>
				<th>N</th>
				<th>Платеж</th>
				<th>Проценты</th>
				<th>Тело</th>
				<th>Осталось</th>
				<th>Переплата?</th>
			</tr>
			<tr ng-repeat="item in year.items">
				<td>{{item.num}}</td>
				<td>{{item.payment | number }}</td>
				<td>{{item.precents | number}}</td>
				<td>{{item.body | number}}</td>
				<td>{{item.remain | number}}</td>
				<td><input ng-model="payments[item.id]" ng-blur="recalc();" type="text" class="form-control"></td>
			</tr>
			<tr>
				<td><b>Итого</b>:</td>
				<td>{{year.payment | number }}</td>
				<td>{{year.precents | number}}</td>
				<td>{{year.body | number}}</td>
				<td></td>
				<td></td>
			</tr>
		</table>
	</div>
</div>

<script>
	angular
			.module('hell', [])
			.controller('enjoy', function ($scope) {
				var defaults = {
					years: 10,
					credit: 3,
					percent: 14.5,
					payment: 50,
					rent: 40,
					income: 100,
					costs: 50
				};

				Object.keys(defaults).forEach(function (key) {
					$scope[key] = localStorage.getItem(key) || defaults[key];
				});

				$scope.payments = {};
				$scope.totalPrecents = 0;
				$scope.recalc = recalc;


				$scope.$watch('years', recalc);
				$scope.$watch('credit', recalc);
				$scope.$watch('percent', recalc);
				$scope.$watch('payment', recalc);


				function recalc() {
					var percent = parseFloat($scope.percent) / 12 / 100,
						months = parseFloat($scope.years) * 12,
						ozs = parseFloat($scope.credit) * 1e6,
						itr = 0,
						year = 0,
						t = 0,
						parts = $scope.payments,
						payment = parseFloat($scope.payment) * 1e3;


					Object.keys(defaults).forEach(function (key) {
						localStorage.setItem(key, $scope[key]);
					});


					$scope.payYears = [];
					$scope.totalPrecents = 0;

					do {
						var OAP = percent + percent / (Math.pow(1 + percent, months) - 1),
								sum = ozs * OAP,
								dp = percent * ozs, // оплата процентов
								dc = sum - dp,	// оплата тела
								_dc = dc,
								_sum = sum;

						if (itr % 12 === 0) {
							$scope.payYears.push(year = {
								num: $scope.payYears.length + 1,
								items: [],
								payment: 0,
								precents: 0,
								body: 0
							});
						}

						if (parts && parts[itr]) { // Переплата
							sum = parts[itr];
							dc = sum - dp;
						}
						else if (payment > sum) {
							if (payment > ozs) dc = ozs;
							else dc = (sum = payment) - dp;
						}


						t += dc + dp;
						ozs -= dc;

						year.payment += _sum;
						year.precents += dp;
						year.body += (_sum - dp);
						$scope.totalPrecents += dp;

						year.items.push({
							id: itr,
							num: (itr + 1 - (itr / 12 | 0) * 12),
							payment: _sum.toFixed(),
							precents: dp.toFixed(),
							body: (_sum - dp).toFixed(),
							remain: ozs.toFixed()
						});

						itr++;
						months--;
					} while (ozs > 1000);

					$scope.total = t;
					$scope.remYears = Math.floor(itr / 12) + ' лет';
					$scope.remMonths = itr - Math.floor(itr / 12) * 12 + ' месяцев';
					$scope.period = itr;
				}
			});
</script>
</body>
</html>
